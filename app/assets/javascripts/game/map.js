var map_refrences = {
    bounds: {
        "WESTEUROPA": {
            "min": {
                "y": "389",
                "x": "618"
            },
            "max": {
                "y": "568",
                "x": "741"
            }
        },
        "GROSSBRITANNIEN": {
            "min": {
                "y": "256",
                "x": "571"
            },
            "max": {
                "y": "398",
                "x": "702"
            }
        },
        "SUEDAFRIKA": {
            "min": {
                "y": "848",
                "x": "801"
            },
            "max": {
                "y": "1057",
                "x": "967"
            }
        },
        "OSTSTAATEN": {
            "min": {
                "y": "306",
                "x": "256"
            },
            "max": {
                "y": "496",
                "x": "450"
            }
        },
        "AFGHANISTAN": {
            "min": {
                "y": "304",
                "x": "990"
            },
            "max": {
                "y": "492",
                "x": "1166"
            }
        },
        "OSTKANADA": {
            "min": {
                "y": "187",
                "x": "384"
            },
            "max": {
                "y": "367",
                "x": "510"
            }
        },
        "INDONESIEN": {
            "min": {
                "y": "731",
                "x": "1241"
            },
            "max": {
                "y": "869",
                "x": "1409"
            }
        },
        "URAL": {
            "min": {
                "y": "80",
                "x": "1060"
            },
            "max": {
                "y": "369",
                "x": "1191"
            }
        },
        "SUEDEUROPA": {
            "min": {
                "y": "389",
                "x": "734"
            },
            "max": {
                "y": "547",
                "x": "879"
            }
        },
        "NORDEUROPA": {
            "min": {
                "y": "280",
                "x": "721"
            },
            "max": {
                "y": "426",
                "x": "869"
            }
        },
        "SUEDOSTASIEN": {
            "min": {
                "y": "546",
                "x": "1247"
            },
            "max": {
                "y": "708",
                "x": "1366"
            }
        },
        "ISLAND": {
            "min": {
                "y": "177",
                "x": "633"
            },
            "max": {
                "y": "241",
                "x": "725"
            }
        },
        "RUSSLAND": {
            "min": {
                "y": "125",
                "x": "838"
            },
            "max": {
                "y": "479",
                "x": "1069"
            }
        },
        "SKANDINAVIEN": {
            "min": {
                "y": "122",
                "x": "740"
            },
            "max": {
                "y": "288",
                "x": "880"
            }
        },
        "IRKUTSK": {
            "min": {
                "y": "183",
                "x": "1220"
            },
            "max": {
                "y": "325",
                "x": "1397"
            }
        },
        "PERU": {
            "min": {
                "y": "641",
                "x": "271"
            },
            "max": {
                "y": "840",
                "x": "462"
            }
        },
        "GROENLAND": {
            "min": {
                "y": "17",
                "x": "428"
            },
            "max": {
                "y": "226",
                "x": "637"
            }
        },
        "ALASKA": {
            "min": {
                "y": "101",
                "x": "18"
            },
            "max": {
                "y": "255",
                "x": "165"
            }
        },
        "CHINA": {
            "min": {
                "y": "339",
                "x": "1142"
            },
            "max": {
                "y": "582",
                "x": "1405"
            }
        },
        "MITTELAMERIKA": {
            "min": {
                "y": "431",
                "x": "176"
            },
            "max": {
                "y": "605",
                "x": "306"
            }
        },
        "MONGOLEI": {
            "min": {
                "y": "281",
                "x": "1235"
            },
            "max": {
                "y": "435",
                "x": "1429"
            }
        },
        "NEUGUINEA": {
            "min": {
                "y": "708",
                "x": "1408"
            },
            "max": {
                "y": "805",
                "x": "1535"
            }
        },
        "ZENTRALAFRIKA": {
            "min": {
                "y": "744",
                "x": "787"
            },
            "max": {
                "y": "898",
                "x": "935"
            }
        },
        "NORDWEST-TERRITORIEN": {
            "min": {
                "y": "74",
                "x": "136"
            },
            "max": {
                "y": "198",
                "x": "403"
            }
        },
        "AEGYPTEN": {
            "min": {
                "y": "586",
                "x": "790"
            },
            "max": {
                "y": "684",
                "x": "937"
            }
        },
        "KAMTSCHATKA": {
            "min": {
                "y": "76",
                "x": "1339"
            },
            "max": {
                "y": "355",
                "x": "1569"
            }
        },
        "ARGENTINIEN": {
            "min": {
                "y": "786",
                "x": "344"
            },
            "max": {
                "y": "1060",
                "x": "474"
            }
        },
        "OSTAUSTRALIEN": {
            "min": {
                "y": "827",
                "x": "1437"
            },
            "max": {
                "y": "1061",
                "x": "1595"
            }
        },
        "SIBIRIEN": {
            "min": {
                "y": "26",
                "x": "1098"
            },
            "max": {
                "y": "368",
                "x": "1288"
            }
        },
        "ONTARIO": {
            "min": {
                "y": "197",
                "x": "283"
            },
            "max": {
                "y": "333",
                "x": "384"
            }
        },
        "VENEZUELA": {
            "min": {
                "y": "567",
                "x": "290"
            },
            "max": {
                "y": "671",
                "x": "477"
            }
        },
        "BRASILIEN": {
            "min": {
                "y": "624",
                "x": "321"
            },
            "max": {
                "y": "881",
                "x": "591"
            }
        },
        "NORDAFRIKA": {
            "min": {
                "y": "554",
                "x": "631"
            },
            "max": {
                "y": "807",
                "x": "865"
            }
        },
        "JAKUTIEN": {
            "min": {
                "y": "55",
                "x": "1249"
            },
            "max": {
                "y": "204",
                "x": "1407"
            }
        },
        "MADAGASKAR": {
            "min": {
                "y": "896",
                "x": "983"
            },
            "max": {
                "y": "1030",
                "x": "1063"
            }
        },
        "JAPAN": {
            "min": {
                "y": "281",
                "x": "1434"
            },
            "max": {
                "y": "465",
                "x": "1524"
            }
        },
        "WESTAUSTRALIEN": {
            "min": {
                "y": "845",
                "x": "1321"
            },
            "max": {
                "y": "1044",
                "x": "1508"
            }
        },
        "MITTLERER-OSTEN": {
            "min": {
                "y": "476",
                "x": "859"
            },
            "max": {
                "y": "712",
                "x": "1100"
            }
        },
        "ALBERTA": {
            "min": {
                "y": "193",
                "x": "154"
            },
            "max": {
                "y": "304",
                "x": "287"
            }
        },
        "OSTAFRIKA": {
            "min": {
                "y": "665",
                "x": "864"
            },
            "max": {
                "y": "923",
                "x": "1033"
            }
        },
        "WESTSTAATEN": {
            "min": {
                "y": "306",
                "x": "162"
            },
            "max": {
                "y": "460",
                "x": "310"
            }
        },
        "INDIEN": {
            "min": {
                "y": "458",
                "x": "1084"
            },
            "max": {
                "y": "728",
                "x": "1266"
            }
        }
    },
    colors: {
        "ARGENTINIEN": [
            254,
            254,
            254
        ],
        "GROSSBRITANNIEN": [
            250,
            4,
            24
        ],
        "SUEDOSTASIEN": [
            244,
            8,
            49
        ],
        "CHINA": [
            238,
            12,
            74
        ],
        "NORDWEST-TERRITORIEN": [
            232,
            16,
            99
        ],
        "SIBIRIEN": [
            226,
            20,
            124
        ],
        "INDONESIEN": [
            220,
            24,
            149
        ],
        "ZENTRALAFRIKA": [
            214,
            28,
            174
        ],
        "SKANDINAVIEN": [
            208,
            32,
            199
        ],
        "NEUGUINEA": [
            202,
            36,
            224
        ],
        "JAPAN": [
            196,
            40,
            249
        ],
        "AEGYPTEN": [
            190,
            45,
            18
        ],
        "BRASILIEN": [
            184,
            49,
            43
        ],
        "PERU": [
            178,
            53,
            68
        ],
        "WESTSTAATEN": [
            172,
            57,
            93
        ],
        "JAKUTIEN": [
            166,
            61,
            118
        ],
        "VENEZUELA": [
            160,
            65,
            143
        ],
        "ALBERTA": [
            154,
            69,
            168
        ],
        "RUSSLAND": [
            148,
            73,
            193
        ],
        "AFGHANISTAN": [
            142,
            77,
            218
        ],
        "NORDAFRIKA": [
            136,
            81,
            243
        ],
        "OSTSTAATEN": [
            130,
            86,
            12
        ],
        "OSTAFRIKA": [
            124,
            90,
            37
        ],
        "INDIEN": [
            118,
            94,
            62
        ],
        "SUEDEUROPA": [
            112,
            98,
            87
        ],
        "SUEDAFRIKA": [
            106,
            102,
            112
        ],
        "ISLAND": [
            100,
            106,
            137
        ],
        "KAMTSCHATKA": [
            94,
            110,
            162
        ],
        "OSTAUSTRALIEN": [
            88,
            114,
            187
        ],
        "MITTELAMERIKA": [
            82,
            118,
            212
        ],
        "WESTAUSTRALIEN": [
            76,
            122,
            237
        ],
        "MONGOLEI": [
            70,
            127,
            6
        ],
        "WESTEUROPA": [
            64,
            131,
            31
        ],
        "MADAGASKAR": [
            58,
            135,
            56
        ],
        "MITTLERER-OSTEN": [
            52,
            139,
            81
        ],
        "OSTKANADA": [
            46,
            143,
            106
        ],
        "ALASKA": [
            40,
            147,
            131
        ],
        "GROENLAND": [
            34,
            151,
            156
        ],
        "ONTARIO": [
            28,
            155,
            181
        ],
        "IRKUTSK": [
            22,
            159,
            206
        ],
        "URAL": [
            16,
            163,
            231
        ],
        "NORDEUROPA": [
            10,
            168,
            0
        ]
    },
    text_position: {
        'ALASKA': {
            'x': 86,
            'y': 162
        },
        'NORDWEST-TERRITORIEN': {
            'x': 233,
            'y': 163
        },
        'ALBERTA': {
            'x': 215,
            'y': 246
        },
        'ONTARIO': {
            'x': 324,
            'y': 272
        },
        'OSTKANADA': {
            'x': 425,
            'y': 285
        },
        'GROENLAND': {
            'x': 529,
            'y': 106
        },
        'WESTSTAATEN': {
            'x': 216,
            'y': 376
        },
        'OSTSTAATEN': {
            'x': 336,
            'y': 424
        },
        'MITTELAMERIKA': {
            'x': 238,
            'y': 484
        },
        'VENEZUELA': {
            'x': 349,
            'y': 610
        },
        'PERU': {
            'x': 383,
            'y': 765
        },
        'BRASILIEN': {
            'x': 481,
            'y': 712
        },
        'ARGENTINIEN': {
            'x': 404,
            'y': 890
        },
        'ISLAND': {
            'x': 676,
            'y': 211
        },
        'GROSSBRITANNIEN': {
            'x': 660,
            'y': 350
        },
        'SKANDINAVIEN': {
            'x': 785,
            'y': 228
        },
        'NORDEUROPA': {
            'x': 788,
            'y': 359
        },
        'WESTEUROPA': {
            'x': 667,
            'y': 512
        },
        'SUEDEUROPA': {
            'x': 781,
            'y': 447
        },
        'RUSSLAND': {
            'x': 926,
            'y': 298
        },
        'URAL': {
            'x': 1110,
            'y': 251
        },
        'SIBIRIEN': {
            'x': 1185,
            'y': 131
        },
        'JAKUTIEN': {
            'x': 1321,
            'y': 123
        },
        'KAMTSCHATKA': {
            'x': 1464,
            'y': 130
        },
        'IRKUTSK': {
            'x': 1290,
            'y': 284
        },
        'MONGOLEI': {
            'x': 1323,
            'y': 371
        },
        'JAPAN': {
            'x': 1494,
            'y': 387
        },
        'AFGHANISTAN': {
            'x': 1079,
            'y': 404
        },
        'CHINA': {
            'x': 1270,
            'y': 481
        },
        'SUEDOSTASIEN': {
            'x': 1307,
            'y': 614
        },
        'INDIEN': {
            'x': 1181,
            'y': 568
        },
        'MITTLERER-OSTEN': {
            'x': 992,
            'y': 532
        },
        'AEGYPTEN': {
            'x': 861,
            'y': 633
        },
        'NORDAFRIKA': {
            'x': 726,
            'y': 689
        },
        'OSTAFRIKA': {
            'x': 974,
            'y': 777
        },
        'ZENTRALAFRIKA': {
            'x': 860,
            'y': 824
        },
        'SUEDAFRIKA': {
            'x': 865,
            'y': 960
        },
        'MADAGASKAR': {
            'x': 1024,
            'y': 963
        },
        'INDONESIEN': {
            'x': 1338,
            'y': 788
        },
        'NEUGUINEA': {
            'x': 1478,
            'y': 760
        },
        'WESTAUSTRALIEN': {
            'x': 1394,
            'y': 968
        },
        'OSTAUSTRALIEN': {
            'x': 1549,
            'y': 980
        }
    }
}

let map_node;
let map_background;
let map_reference;
let map_width;
let map_height;
let map_ctx_map;
let map_ref;
let map_ctx_ref;
let map_img_map;
let map_img_ref;
let map_img_loaded = 0;
let map_data = {};

function _map_init(node, width=1650, height=1080) {
    if (typeof map_refrences === "undefined" || !window.jQuery) return;
    map_node = node;
    map_node.className = "map_view";
    $(map_node).wrap("<div class='map_container'><div class='map_scale'></div></div>");
    map_node.onclick = map_click;
    if (!node.hasAttribute("data-map") || !node.hasAttribute("data-ref")) return;
    map_background = node.getAttribute("data-map");
    map_reference = node.getAttribute("data-ref");
    map_width = width;
    map_height = height;
    Object.keys(map_refrences.colors).forEach(function(name) {
        map_data[name] = map_refrences.colors[name];//[255, 255, 255];
    });
    map_load_();
}

function getScale() {
    return parseInt($('.map_scale').css("font-size")) / parseInt($('.map_container').css("font-size"));
}

function map_load_() {
    map_node.setAttribute("width", map_width);
    map_node.setAttribute("height", map_height);
    map_ctx_map = map_node.getContext("2d");

    map_ref = document.createElement("canvas");
    $(map_ref).wrap("<div class='map_container'><div class='map_scale'></div></div>");
    map_ref.className = "map_view";
    map_ref.setAttribute("width", map_width);
    map_ref.setAttribute("height", map_height);
    map_ctx_ref = map_ref.getContext("2d");

    map_img_map = document.createElement("img");
    map_img_ref = document.createElement("img");
    map_img_map.onload = map_load_img;
    map_img_ref.onload = map_load_img;
    map_img_map.src = map_background;
    map_img_ref.src = map_reference;
    map_ctx_map.font = "bold " + parseInt($('.map_scale').css("font-size"))*0.5 + "px Arial";
}

function map_load_img() {
    if (map_img_loaded == 1) {
        map_draw();
        delete map_img_loaded;
    } else {
        map_img_loaded++;
    }
}

function map_draw() {
    map_ctx_map.drawImage(map_img_map, 0, 0, map_width, map_height);
    map_ctx_ref.drawImage(map_img_ref, 0, 0, map_width, map_height);
    Object.keys(map_data).forEach(function(name) {
        map_draw_country(name, map_data[name]);
    });
}

function map_draw_country(name, color, count=0) {
    let bounds = map_refrences.bounds[name];
    if (typeof bounds === "undefined") return;
    let width = bounds.max.x - bounds.min.x;
    let height = bounds.max.y - bounds.min.y;
    let ref_data = map_ctx_ref.getImageData(bounds.min.x, bounds.min.y, width, height).data;
    let draw_data = map_ctx_map.getImageData(bounds.min.x, bounds.min.y, width, height).data;
    for (let i = ref_data.indexOf(map_refrences.colors[name][0]); i < ref_data.length && i !== -1; i += 4){
        if (map_refrences.colors[name][0] === ref_data[i] && map_refrences.colors[name][1] === ref_data[i + 1] &&
            map_refrences.colors[name][2] === ref_data[i + 2]) {
            // same color
            if (color[0] === draw_data[i] && color[1] === draw_data[i + 1] &&
                color[2] === draw_data[i + 2]) return;
            // different color => recolor
            draw_data[i] = color[0];
            draw_data[i + 1] = color[1];
            draw_data[i + 2] = color[2];
        }
    }
    let newImageData = map_ctx_map.createImageData(width, height);
    newImageData.data.set(draw_data);
    map_ctx_map.putImageData(newImageData, bounds.min.x, bounds.min.y);
    map_ctx_map.fillText(count + "T", map_refrences.text_position[name].x - 16, map_refrences.text_position[name].y + 12);
}

function map_position_to_land(x, y) {
    let ref_color = map_ctx_ref.getImageData(x, y, 1, 1).data;
    let land = [];
    if (ref_color.length >= 3) {
        land = Object.keys(map_refrences.colors).filter(function(land) {
            if(ref_color[0] === map_refrences.colors[land][0] &&
                ref_color[1] === map_refrences.colors[land][1] &&
                ref_color[2] === map_refrences.colors[land][2]) {
                return true;
            }
            return false;
        });
    }
    return land.join();
}

function map_display_continent() {
    let continents = {
        "ARGENTINIEN": [
            11,
            53,
            89
        ],
        "GROSSBRITANNIEN": [
            88,
            116,
            140
        ],
        "SUEDOSTASIEN": [
            235,
            221,
            208
        ],
        "CHINA": [
            235,
            221,
            208
        ],
        "NORDWEST-TERRITORIEN": [
            9,
            40,
            62
        ],
        "SIBIRIEN": [
            235,
            221,
            208
        ],
        "INDONESIEN": [
            161,
            170,
            177
        ],
        "ZENTRALAFRIKA": [
            36,
            84,
            115
        ],
        "SKANDINAVIEN": [
            88,
            116,
            140
        ],
        "NEUGUINEA": [
            161,
            170,
            177
        ],
        "JAPAN": [
            235,
            221,
            208
        ],
        "AEGYPTEN": [
            36,
            84,
            115
        ],
        "BRASILIEN": [
            11,
            53,
            89
        ],
        "PERU": [
            11,
            53,
            89
        ],
        "WESTSTAATEN": [
            9,
            40,
            62
        ],
        "JAKUTIEN": [
            235,
            221,
            208
        ],
        "VENEZUELA": [
            11,
            53,
            89
        ],
        "ALBERTA": [
            9,
            40,
            62
        ],
        "RUSSLAND": [
            88,
            116,
            140
        ],
        "AFGHANISTAN": [
            235,
            221,
            208
        ],
        "NORDAFRIKA": [
            36,
            84,
            115
        ],
        "OSTSTAATEN": [
            9,
            40,
            62
        ],
        "OSTAFRIKA": [
            36,
            84,
            115
        ],
        "INDIEN": [
            235,
            221,
            208
        ],
        "SUEDEUROPA": [
            88,
            116,
            140
        ],
        "SUEDAFRIKA": [
            36,
            84,
            115
        ],
        "ISLAND": [
            88,
            116,
            140
        ],
        "KAMTSCHATKA": [
            235,
            221,
            208
        ],
        "OSTAUSTRALIEN": [
            161,
            170,
            177
        ],
        "MITTELAMERIKA": [
            9,
            40,
            62
        ],
        "WESTAUSTRALIEN": [
            161,
            170,
            177
        ],
        "MONGOLEI": [
            235,
            221,
            208
        ],
        "WESTEUROPA": [
            88,
            116,
            140
        ],
        "MADAGASKAR": [
            36,
            84,
            115
        ],
        "MITTLERER-OSTEN": [
            235,
            221,
            208
        ],
        "OSTKANADA": [
            9,
            40,
            62
        ],
        "ALASKA": [
            9,
            40,
            62
        ],
        "GROENLAND": [
            9,
            40,
            62
        ],
        "ONTARIO": [
            9,
            40,
            62
        ],
        "IRKUTSK": [
            235,
            221,
            208
        ],
        "URAL": [
            235,
            221,
            208
        ],
        "NORDEUROPA": [
            88,
            116,
            140
        ]
    };
    let temp_map_data = map_data;
    map_data = continents;
    map_draw();
    map_data = temp_map_data;
}

function map_click(event) {
    var rect = map_node.getBoundingClientRect();
    let x = event.clientX - rect.left;
    let y = event.clientY - rect.top;
    console.log("Land: " + map_position_to_land(x/getScale(), y/getScale()) + "; X: " + x/getScale() + " Y: " + y/getScale());
    map_draw_country(map_position_to_land(x/getScale(), y/getScale()), [Math.random() * 256, Math.random() * 256, Math.random() * 256]);
}

function map_hover(event) {
    var rect = map_node.getBoundingClientRect();
    let x = event.clientX - rect.left;
    let y = event.clientY - rect.top;
}